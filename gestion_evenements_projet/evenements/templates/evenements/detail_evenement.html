{% extends 'evenements/base.html' %}

{% block title %}{{ evenement.titre }}{% endblock %}

{% block extra_css %}
<style>
    .participant-card {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        margin-bottom: 0.8rem;
        border-left: 4px solid #10b981;
        transition: all 0.3s ease;
    }
    
    .participant-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .participant-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .inscription-status {
        padding: 0.3rem 0.8rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .export-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 10px;
    transition: all 0.3s ease;
    z-index: 10;
    position: relative;
}

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accueil' %}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{% url 'liste_evenements' %}">√âv√©nements</a></li>
            <li class="breadcrumb-item active">{{ evenement.titre }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- D√©tails de l'√©v√©nement -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-body">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h2 mb-2">{{ evenement.titre }}</h1>
                            <div>
                                <span class="badge bg-primary me-2">{{ evenement.get_categorie_display }}</span>
                                <span class="badge 
                                    {% if evenement.statut == 'valide' %}bg-success
                                    {% elif evenement.statut == 'en_attente' %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ evenement.get_statut_display }}
                                </span>
                                {% if evenement.est_passe %}
                                    <span class="badge bg-secondary">Termin√©</span>
                                {% elif evenement.est_complet %}
                                    <span class="badge bg-danger">Complet</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Actions pour l'organisateur -->
                        {% if evenement.organisateur == user or user.est_admin %}
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-gear"></i> G√©rer
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="{% url 'modifier_evenement' evenement.pk %}">
                                            <i class="bi bi-pencil"></i> Modifier
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{% url 'supprimer_evenement' evenement.pk %}">
                                            <i class="bi bi-trash"></i> Supprimer
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <h5><i class="bi bi-card-text"></i> Description</h5>
                        <p class="text-muted">{{ evenement.description|linebreaks }}</p>
                    </div>

                    <!-- Informations d√©taill√©es -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6><i class="bi bi-calendar3"></i> Date et heure</h6>
                            <p class="mb-1">
                                <strong>D√©but :</strong> {{ evenement.date_debut|date:"d/m/Y √† H:i" }}
                            </p>
                            <p class="mb-0">
                                <strong>Fin :</strong> {{ evenement.date_fin|date:"d/m/Y √† H:i" }}
                            </p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><i class="bi bi-geo-alt"></i> Lieu</h6>
                            <p class="mb-0">{{ evenement.lieu }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><i class="bi bi-person"></i> Organisateur</h6>
                            <p class="mb-0">{{ evenement.organisateur.get_full_name }}</p>
                            {% if evenement.organisateur.departement %}
                                <small class="text-muted">{{ evenement.organisateur.departement }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><i class="bi bi-people"></i> Participants</h6>
                            <p class="mb-0">
                                <strong>{{ evenement.nombre_inscrits }}</strong> / {{ evenement.capacite_max }} inscrits
                            </p>
                            <div class="progress" style="height: 10px;">
                                {% widthratio evenement.nombre_inscrits evenement.capacite_max 100 as percentage %}
                               
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liste des inscrits (visible par organisateur et admin) -->
            {% if inscrits %}
                <div class="card mt-4">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people-fill"></i> Liste des participants ({{ inscrits.count }})
                            </h5>
                           <button type="button" class="export-btn" onclick="exporterParticipants()">
                               <i class="bi bi-download"></i> Exporter
                           </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if inscrits %}
                            {% for inscription in inscrits %}
                                <div class="participant-card">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="participant-avatar">
                                            {{ inscription.participant.first_name|first|upper }}{{ inscription.participant.last_name|first|upper }}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold">
                                                {{ inscription.participant.get_full_name }}
                                            </h6>
                                            <div class="small text-muted">
                                                <i class="bi bi-envelope"></i> {{ inscription.participant.email }}
                                                {% if inscription.participant.departement %}
                                                    <span class="ms-3">
                                                        <i class="bi bi-building"></i> {{ inscription.participant.departement }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="small text-muted mt-1">
                                                <i class="bi bi-clock"></i> Inscrit le {{ inscription.date_inscription|date:"d/m/Y √† H:i" }}
                                            </div>
                                        </div>
                                        <span class="inscription-status bg-success text-white">
                                            <i class="bi bi-check-circle"></i> Confirm√©
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-people display-1 text-muted"></i>
                                <p class="text-muted mt-3">Aucun participant inscrit pour le moment</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions d'inscription -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    {% if evenement.statut != 'valide' %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Cet √©v√©nement n'est pas encore valid√©.
                        </div>
                    {% elif evenement.est_passe %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-calendar-x"></i>
                            Cet √©v√©nement est termin√©.
                        </div>
                    {% elif est_inscrit %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>Vous √™tes inscrit !</strong>
                        </div>
                        <form method="post" action="{% url 'annuler_inscription' evenement.pk %}" onsubmit="return confirm('√ätes-vous s√ªr de vouloir annuler votre inscription ?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-x-circle"></i> Annuler mon inscription
                            </button>
                        </form>
                    {% elif evenement.est_complet %}
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-circle"></i>
                            Cet √©v√©nement est complet
                        </div>
                    {% else %}
                        <h5 class="mb-3">Rejoindre cet √©v√©nement</h5>
                        <form method="post" action="{% url 'inscrire_evenement' evenement.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-check-circle"></i> S'inscrire maintenant
                            </button>
                        </form>
                        <small class="text-muted mt-2 d-block">
                            Inscription gratuite et instantan√©e
                        </small>
                    {% endif %}
                </div>
            </div>

            <!-- Informations compl√©mentaires -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <small class="text-muted d-block">Cr√©√© le</small>
                            <strong>{{ evenement.date_creation|date:"d/m/Y √† H:i" }}</strong>
                        </li>
                        <li class="mb-3">
                            <small class="text-muted d-block">Derni√®re modification</small>
                            <strong>{{ evenement.date_modification|date:"d/m/Y √† H:i" }}</strong>
                        </li>
                        <li class="mb-3">
                            <small class="text-muted d-block">Places restantes</small>
                            {% widthratio evenement.nombre_inscrits evenement.capacite_max 100 as percentage %}
                            <strong class="{% if percentage >= 90 %}text-danger{% elif percentage >= 70 %}text-warning{% else %}text-success{% endif %}">
                                {{ evenement.capacite_max|add:evenement.nombre_inscrits|add:"-"|add:evenement.nombre_inscrits }} places
                            </strong>
                        </li>
                        <li>
                            <small class="text-muted d-block">Taux de remplissage</small>
                            <strong>{{ percentage }}%</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function exporterParticipants() {

        const participants = [];

        document.querySelectorAll('.participant-card').forEach(card => {
            
            const nom = card.querySelector('h6').innerText.trim();

            const emailElement = card.querySelector('.bi-envelope');
            let email = "";
            if (emailElement) {
                email = emailElement.parentElement.innerText.replace("üìß", "").trim();
            }

            const dateElement = card.querySelector('.bi-clock');
            let date = "";
            if (dateElement) {
                date = dateElement.parentElement.innerText.replace("üïí", "").trim();
            }

            participants.push({ nom, email, date });
        });

        if (participants.length === 0) {
            alert("Aucun participant √† exporter !");
            return;
        }

        let csv = "Nom,Email,Date inscription\n";

        participants.forEach(p => {
            csv += `"${p.nom}","${p.email}","${p.date}"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "participants_{{ evenement.titre|slugify }}.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
